{% load static %}

<!-- SCRIPT DEFINIDO PRIMERO -->
<script>
    const eventId = {{ event.id }};
    const csrfToken = '{{ csrf_token }}';
    const isEventLive = {% if event.status == 'live' %}true{% else %}false{% endif %};
    const isAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};
    const currentUserId = {% if user.is_authenticated %}{{ user.id }}{% else %}null{% endif %};
    const currentUsername = '{% if user.is_authenticated %}{{ user.username }}{% else %}{% endif %}';
</script>

<!-- HTML DEL CHAT -->
<div class="chat-container card">
    <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
        <h5 class="mb-0"> Xat en Directe</h5>
        <span class="badge bg-light text-primary" id="message-count">0</span>
    </div>

    <div class="card-body p-0" style="height: 400px; overflow-y: auto;">
        <div id="chat-messages" class="p-3">
            <!-- Los mensajes se cargar谩n aqu铆 -->
            <div class="text-center text-muted py-5">
                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                <p class="mb-0">Carregant missatges...</p>
            </div>
        </div>
    </div>

    <div class="card-footer">
        {% if user.is_authenticated %}
            {% if event.status == 'live' %}
                <form id="chat-form">
                    {% csrf_token %}
                    <textarea
                        id="chat-input"
                        class="form-control mb-2"
                        rows="2"
                        placeholder="Escriu el teu missatge aqu铆..."
                        maxlength="500"
                        required></textarea>
                    <div id="chat-errors" class="text-danger small mb-1"></div>
                    <button type="submit" class="btn btn-primary btn-sm w-100">
                        <i class="fas fa-paper-plane me-1"></i> Enviar
                    </button>
                </form>
            {% else %}
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    El xat nom茅s est disponible durant l'esdeveniment en directe.
                </div>
            {% endif %}
        {% else %}
            <div class="alert alert-info mb-0">
                <i class="fas fa-info-circle me-1"></i>
                <a href="{% url 'users:login' %}?next={{ request.path }}" class="alert-link">
                    Inicia sessi贸
                </a> per participar al xat.
            </div>
        {% endif %}
    </div>
</div>

<!-- SCRIPT NICO Y FUNCIONAL CON ELIMINAR -->
<script>
(function() {
    // Elementos
    const messagesBox = document.getElementById('chat-messages');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('chat-input');
    const errorsBox = document.getElementById('chat-errors');
    const messageCount = document.getElementById('message-count');

    // Funci贸n para escapar HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Funci贸n para eliminar mensaje
    function deleteMessage(messageId, button) {
        if (!confirm('驴Ests segur de voler eliminar aquest missatge?')) {
            return;
        }

        fetch(`/chat/message/${messageId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // Marcar como eliminado en la interfaz
                const messageElement = button.closest('.chat-message-item');
                if (messageElement) {
                    const contentDiv = messageElement.querySelector('.message-content');
                    if (contentDiv) {
                        contentDiv.innerHTML = '<em class="text-muted">Missatge eliminat</em>';
                        contentDiv.classList.add('text-muted', 'fst-italic');
                    }

                    // Ocultar bot贸n de eliminar
                    button.style.display = 'none';

                    // Reducir contador
                    if (messageCount) {
                        const current = parseInt(messageCount.textContent) || 0;
                        if (current > 0) {
                            messageCount.textContent = current - 1;
                        }
                    }
                }
            } else {
                alert('Error: ' + (data.error || 'No es pot eliminar'));
            }
        })
        .catch(err => {
            console.error('Error eliminando:', err);
            alert('Error de connexi贸');
        });
    }

    // Cargar mensajes
    function loadMessages() {
        fetch(`/chat/${eventId}/messages/`)
            .then(r => {
                if (!r.ok) throw new Error('HTTP ' + r.status);
                return r.json();
            })
            .then(data => {
                if (!data.messages) {
                    throw new Error('Formato de datos incorrecto');
                }

                // Limpiar solo si hay mensajes
                if (data.messages.length > 0) {
                    let messagesHTML = '';

                    // Actualizar contador
                    if (messageCount) {
                        messageCount.textContent = data.messages.length;
                    }

                    // Construir HTML de mensajes
                    data.messages.forEach(msg => {
                        // Bot贸n de eliminar (solo si can_delete es true)
                        let deleteButton = '';
                        if (msg.can_delete) {
                            deleteButton = `
                                <button class="btn-delete-message btn btn-sm btn-outline-danger border-0 py-0 px-2"
                                        onclick="deleteMessage(${msg.id}, this)"
                                        title="Eliminar missatge">
                                    <i class="fas fa-trash-alt fa-xs"></i>
                                </button>
                            `;
                        }

                        messagesHTML += `
                            <div class="chat-message-item mb-3 p-3 rounded border ${msg.is_highlighted ? 'bg-warning-subtle' : ''}"
                                 data-message-id="${msg.id}">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <div class="d-flex align-items-center">
                                        <strong class="message-username me-2">${escapeHtml(msg.display_name)}</strong>
                                        ${msg.display_name === currentUsername ?
                                            '<span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 py-1 px-2" style="font-size: 0.65rem;">Tu</span>' :
                                            ''}
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <small class="message-time text-muted">${escapeHtml(msg.created_at)}</small>
                                        ${deleteButton}
                                    </div>
                                </div>
                                <div class="message-content mt-2">${escapeHtml(msg.message)}</div>
                            </div>
                        `;
                    });

                    messagesBox.innerHTML = messagesHTML;

                    // Scroll al final si el usuario estaba abajo
                    const isAtBottom = messagesBox.parentElement.scrollHeight -
                                       messagesBox.parentElement.clientHeight <=
                                       messagesBox.parentElement.scrollTop + 50;

                    if (isAtBottom) {
                        messagesBox.parentElement.scrollTop = messagesBox.parentElement.scrollHeight;
                    }
                } else {
                    // No hay mensajes
                    messagesBox.innerHTML = `
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-comments fa-3x mb-3 opacity-25"></i>
                            <h6 class="mb-1">No hi ha missatges encara</h6>
                            <p class="small mb-0">Sigues el primer a escriure!</p>
                        </div>`;
                    if (messageCount) {
                        messageCount.textContent = '0';
                    }
                }
            })
            .catch(err => {
                console.error('Error cargando mensajes:', err);
                messagesBox.innerHTML = `
                    <div class="text-center text-danger py-5">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <h6 class="mb-1">Error carregant missatges</h6>
                        <p class="small mb-0">Torna a intentar-ho en uns moments</p>
                    </div>`;
            });
    }

    // Enviar mensaje
    if (form && input) {
        form.onsubmit = function(e) {
            e.preventDefault();

            // Limpiar errores
            if (errorsBox) {
                errorsBox.textContent = '';
                errorsBox.className = 'text-danger small';
            }

            const message = input.value.trim();

            // Validaciones
            if (!message) {
                if (errorsBox) {
                    errorsBox.textContent = 'El missatge no pot estar buit';
                }
                input.focus();
                return;
            }

            if (message.length > 500) {
                if (errorsBox) {
                    errorsBox.textContent = 'Mxim 500 carcters';
                }
                return;
            }

            // Deshabilitar bot贸n durante el env铆o
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Enviant...';

            // Enviar mensaje
            fetch(`/chat/${eventId}/send/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `message=${encodeURIComponent(message)}`
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Limpiar input
                    input.value = '';

                    // Recargar mensajes
                    loadMessages();

                    // Enfocar de nuevo
                    input.focus();
                } else {
                    // Mostrar error
                    if (errorsBox) {
                        errorsBox.textContent = data.error || 'Error enviant el missatge';
                    }
                }
            })
            .catch(err => {
                console.error('Error enviando:', err);
                if (errorsBox) {
                    errorsBox.textContent = 'Error de connexi贸';
                }
            })
            .finally(() => {
                // Rehabilitar bot贸n
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        };
    }

    // Hacer funci贸n global para el onclick
    window.deleteMessage = deleteMessage;

    // Iniciar
    if (isEventLive && isAuthenticated) {
        loadMessages();
        setInterval(loadMessages, 3000); // Actualizar cada 3 segundos
    } else if (isEventLive && !isAuthenticated) {
        // Solo cargar mensajes (modo lectura)
        loadMessages();
        setInterval(loadMessages, 5000);
    }

})();
</script>

<!-- CSS COMPLETO PARA EL CHAT -->
<style>
.chat-container {
    max-height: 600px;
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

#chat-messages {
    min-height: 300px;
    background-color: #f8f9fa;
}

.chat-message-item {
    background-color: white;
    border: 1px solid #e9ecef !important;
    transition: all 0.2s ease;
    position: relative;
}

.chat-message-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transform: translateY(-1px);
}

.message-username {
    color: #495057;
    font-size: 0.9rem;
}

.message-time {
    font-size: 0.75rem;
    white-space: nowrap;
}

.message-content {
    word-wrap: break-word;
    line-height: 1.5;
    color: #212529;
    font-size: 0.9rem;
}

/* Bot贸n de eliminar */
.btn-delete-message {
    opacity: 0.5;
    transition: all 0.2s ease;
    padding: 2px 6px !important;
    font-size: 0.7rem;
    border-radius: 4px;
}

.btn-delete-message:hover {
    opacity: 1;
    background-color: #dc3545 !important;
    color: white !important;
    transform: scale(1.1);
}

/* Scrollbar personalizado */
.card-body::-webkit-scrollbar {
    width: 6px;
}

.card-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.card-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

.card-body::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Animaci贸n para nuevos mensajes */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.chat-message-item:last-child {
    animation: fadeIn 0.3s ease-out;
}

/* Estilos para mensajes eliminados */
.message-content.text-muted.fst-italic {
    opacity: 0.7;
    font-size: 0.85rem;
}

/* Input de chat */
#chat-input {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    resize: none;
    font-size: 0.9rem;
    transition: all 0.2s ease;
}

#chat-input:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
}

/* Responsive */
@media (max-width: 768px) {
    .chat-container {
        max-height: 500px;
    }

    #chat-messages {
        min-height: 250px;
    }

    .chat-message-item {
        padding: 10px !important;
        margin-bottom: 10px !important;
    }

    .message-username {
        font-size: 0.85rem;
    }

    .message-content {
        font-size: 0.85rem;
    }
}
</style>